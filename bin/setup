#!/bin/bash

# Setup the agent project

set -e

cd "$(dirname "$0")/.."

echo "ü§ñ Setting up your agent project..."
echo ""

# Get project name - MANDATORY (must start with agent-)
if [ -z "$1" ]; then
    while true; do
        read -p "Project name (agent-*): " PROJECT_NAME
        if [ -z "$PROJECT_NAME" ]; then
            echo "‚ùå Project name is required"
        elif ! [[ "$PROJECT_NAME" =~ ^agent-[a-z0-9][a-z0-9_-]*$ ]]; then
            echo "‚ùå Project name must follow pattern: agent-<name>"
            echo "   Examples: agent-charlie, agent-orchestrator, agent-tool-1"
            echo "   Use lowercase letters, numbers, hyphens, and underscores after 'agent-'"
        else
            break
        fi
    done
else
    PROJECT_NAME=$1
    if ! [[ "$PROJECT_NAME" =~ ^agent-[a-z0-9][a-z0-9_-]*$ ]]; then
        echo "‚ùå Project name must follow pattern: agent-<name>"
        echo "   Examples: agent-charlie, agent-orchestrator, agent-tool-1"
        echo "   Use lowercase letters, numbers, hyphens, and underscores after 'agent-'"
        exit 1
    fi
fi

# Get description - MANDATORY
if [ -z "$2" ]; then
    while true; do
        read -p "Description: " DESCRIPTION
        if [ -z "$DESCRIPTION" ]; then
            echo "‚ùå Description is required"
        else
            break
        fi
    done
else
    DESCRIPTION=$2
fi

# Get author - OPTIONAL (must be in "Name <email@example.com>" format if provided)
if [ -z "$3" ]; then
    GIT_USER=$(git config user.name 2>/dev/null || echo "")
    GIT_EMAIL=$(git config user.email 2>/dev/null || echo "")
    if [ -n "$GIT_USER" ] && [ -n "$GIT_EMAIL" ]; then
        DEFAULT_AUTHOR="$GIT_USER <$GIT_EMAIL>"
    else
        DEFAULT_AUTHOR="Your Name <you@example.com>"
    fi
    while true; do
        read -p "Author (Name <email@example.com>) [$DEFAULT_AUTHOR]: " INPUT_AUTHOR
        AUTHOR=${INPUT_AUTHOR:-$DEFAULT_AUTHOR}
        # Validate format: Name <email@domain.com>
        if [[ "$AUTHOR" =~ ^.+\ \<.+@.+\>$ ]]; then
            break
        else
            echo "‚ùå Invalid format. Use: Name <email@example.com>"
            if [ -z "$INPUT_AUTHOR" ]; then
                # If they just hit enter, use default anyway
                AUTHOR=$DEFAULT_AUTHOR
                break
            fi
        fi
    done
else
    AUTHOR=$3
    if ! [[ "$AUTHOR" =~ ^.+\ \<.+@.+\>$ ]]; then
        echo "‚ùå Invalid author format. Use: Name <email@example.com>"
        exit 1
    fi
fi

echo ""

# Check if poetry is installed
if ! command -v poetry &> /dev/null; then
    echo "‚ùå Poetry is not installed. Install it first:"
    echo "   pip install poetry"
    exit 1
fi

# Update pyproject.toml with project details
echo "üìù Updating pyproject.toml..."

# Escape special chars for sed (/, &, \, ", and newlines)
escape_sed() {
    printf '%s\n' "$1" | sed -e 's/[\/&"]/\\&/g'
}

ESCAPED_NAME=$(escape_sed "$PROJECT_NAME")
ESCAPED_DESC=$(escape_sed "$DESCRIPTION")
ESCAPED_AUTHOR=$(escape_sed "$AUTHOR")

if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' "s/^name = .*/name = \"$ESCAPED_NAME\"/" pyproject.toml
    sed -i '' "s/^description = .*/description = \"$ESCAPED_DESC\"/" pyproject.toml
    sed -i '' "s/^authors = .*/authors = [\"$ESCAPED_AUTHOR\"]/" pyproject.toml
else
    # Linux
    sed -i "s/^name = .*/name = \"$ESCAPED_NAME\"/" pyproject.toml
    sed -i "s/^description = .*/description = \"$ESCAPED_DESC\"/" pyproject.toml
    sed -i "s/^authors = .*/authors = [\"$ESCAPED_AUTHOR\"]/" pyproject.toml
fi

echo "   Project: $PROJECT_NAME"
echo "   Description: $DESCRIPTION"
echo "   Author: $AUTHOR"
echo ""

# Configure Poetry
echo "üì¶ Configuring Poetry..."
poetry config virtualenvs.in-project true

# Install dependencies
echo "üì• Installing dependencies from pyproject.toml..."
echo "   Core: fastapi, uvicorn, deepagents, openai"
echo "   DB: pymongo, certifi"
echo "   Config: pydantic, pydantic-settings, python-dotenv"
echo "   Dev: pytest, httpx, black, mypy, ruff, pre-commit"
poetry install

# Install pre-commit hooks
echo "ü™ù Installing pre-commit hooks..."
poetry run pre-commit install

# Create .env from example if it doesn't exist
if [ ! -f ".env" ]; then
    if [ -f "env.example" ]; then
        echo "üìù Creating .env file..."
        cp env.example .env
        echo ""
        echo "‚ö†Ô∏è  Important: Edit .env and add your OPENAI_API_KEY"
    else
        echo "üìù Creating .env file..."
        cat > .env << EOF
# OpenAI API Key (required)
OPENAI_API_KEY=your_openai_api_key_here

# MongoDB Connection (optional)
MONGO_CONNECTION_STRING=mongodb://localhost:27017
EOF
    fi
else
    echo "‚úÖ .env file already exists"
fi

echo ""
echo "‚úÖ Setup complete!"
echo ""
echo "Next steps:"
echo "1. Edit .env and add your OPENAI_API_KEY"
echo "2. Customize src/agent/system_prompt.txt"
echo "3. Run: bin/run"
echo ""
echo "Pre-commit hooks installed. Your commits will be automatically checked for:"
echo "  - Code formatting (black)"
echo "  - Linting (ruff)"
echo "  - Type checking (mypy)"
echo "  - Common issues (trailing whitespace, secrets, etc.)"
echo ""
