#!/bin/bash

# Setup the agent project

set -e

cd "$(dirname "$0")/.."

# Get parameters or use defaults
PROJECT_NAME=${1:-"my-agent"}
DESCRIPTION=${2:-"AI agent built with deepagents"}
AUTHOR=${3:-"Your Name <you@example.com>"}

echo "ðŸ¤– Setting up your agent project..."
echo ""

# Check if poetry is installed
if ! command -v poetry &> /dev/null; then
    echo "âŒ Poetry is not installed. Install it first:"
    echo "   pip install poetry"
    exit 1
fi

# Update pyproject.toml with project details
echo "ðŸ“ Updating pyproject.toml..."
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' "s/^name = .*/name = \"$PROJECT_NAME\"/" pyproject.toml
    sed -i '' "s/^description = .*/description = \"$DESCRIPTION\"/" pyproject.toml
    sed -i '' "s/^authors = .*/authors = [\"$AUTHOR\"]/" pyproject.toml
else
    # Linux
    sed -i "s/^name = .*/name = \"$PROJECT_NAME\"/" pyproject.toml
    sed -i "s/^description = .*/description = \"$DESCRIPTION\"/" pyproject.toml
    sed -i "s/^authors = .*/authors = [\"$AUTHOR\"]/" pyproject.toml
fi

echo "   Project: $PROJECT_NAME"
echo "   Description: $DESCRIPTION"
echo "   Author: $AUTHOR"
echo ""

# Configure Poetry
echo "ðŸ“¦ Configuring Poetry..."
poetry config virtualenvs.in-project true

# Install dependencies
echo "ðŸ“¥ Installing dependencies from pyproject.toml..."
echo "   Core: fastapi, uvicorn, deepagents, openai"
echo "   DB: pymongo, certifi"
echo "   Config: pydantic, pydantic-settings, python-dotenv"
echo "   Dev: pytest, httpx, black, mypy, ruff, pre-commit"
poetry install

# Install pre-commit hooks
echo "ðŸª Installing pre-commit hooks..."
poetry run pre-commit install

# Create .env from example if it doesn't exist
if [ ! -f ".env" ]; then
    if [ -f "env.example" ]; then
        echo "ðŸ“ Creating .env file..."
        cp env.example .env
        echo ""
        echo "âš ï¸  Important: Edit .env and add your OPENAI_API_KEY"
    else
        echo "ðŸ“ Creating .env file..."
        cat > .env << EOF
# OpenAI API Key (required)
OPENAI_API_KEY=your_openai_api_key_here

# MongoDB Connection (optional)
MONGO_CONNECTION_STRING=mongodb://localhost:27017
EOF
    fi
else
    echo "âœ… .env file already exists"
fi

echo ""
echo "âœ… Setup complete!"
echo ""
echo "Next steps:"
echo "1. Edit .env and add your OPENAI_API_KEY"
echo "2. Customize src/agent/system_prompt.txt"
echo "3. Run: bin/run"
echo ""
echo "Pre-commit hooks installed. Your commits will be automatically checked for:"
echo "  - Code formatting (black)"
echo "  - Linting (ruff)"
echo "  - Type checking (mypy)"
echo "  - Common issues (trailing whitespace, secrets, etc.)"
echo ""
