#!/bin/bash

# Setup the agent project

set -e

cd "$(dirname "$0")/.."

echo "ðŸ¤– Setting up your agent project..."
echo ""

# Get project name from repo or prompt
if [ -z "$1" ]; then
    # Try to get repo name from git remote
    REPO_NAME=$(basename -s .git "$(git config --get remote.origin.url 2>/dev/null)" 2>/dev/null || basename "$(pwd)")
    read -p "Project name [$REPO_NAME]: " INPUT_NAME
    PROJECT_NAME=${INPUT_NAME:-$REPO_NAME}
else
    PROJECT_NAME=$1
fi

# Get description
if [ -z "$2" ]; then
    read -p "Description [AI agent built with deepagents]: " INPUT_DESC
    DESCRIPTION=${INPUT_DESC:-"AI agent built with deepagents"}
else
    DESCRIPTION=$2
fi

# Get author
if [ -z "$3" ]; then
    GIT_USER=$(git config user.name 2>/dev/null || echo "")
    GIT_EMAIL=$(git config user.email 2>/dev/null || echo "")
    if [ -n "$GIT_USER" ] && [ -n "$GIT_EMAIL" ]; then
        DEFAULT_AUTHOR="$GIT_USER <$GIT_EMAIL>"
    else
        DEFAULT_AUTHOR="Your Name <you@example.com>"
    fi
    read -p "Author [$DEFAULT_AUTHOR]: " INPUT_AUTHOR
    AUTHOR=${INPUT_AUTHOR:-$DEFAULT_AUTHOR}
else
    AUTHOR=$3
fi

echo ""

# Check if poetry is installed
if ! command -v poetry &> /dev/null; then
    echo "âŒ Poetry is not installed. Install it first:"
    echo "   pip install poetry"
    exit 1
fi

# Update pyproject.toml with project details
echo "ðŸ“ Updating pyproject.toml..."

# Escape special chars for sed (/, &, \, ", and newlines)
escape_sed() {
    printf '%s\n' "$1" | sed -e 's/[\/&"]/\\&/g'
}

ESCAPED_NAME=$(escape_sed "$PROJECT_NAME")
ESCAPED_DESC=$(escape_sed "$DESCRIPTION")
ESCAPED_AUTHOR=$(escape_sed "$AUTHOR")

if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' "s/^name = .*/name = \"$ESCAPED_NAME\"/" pyproject.toml
    sed -i '' "s/^description = .*/description = \"$ESCAPED_DESC\"/" pyproject.toml
    sed -i '' "s/^authors = .*/authors = [\"$ESCAPED_AUTHOR\"]/" pyproject.toml
else
    # Linux
    sed -i "s/^name = .*/name = \"$ESCAPED_NAME\"/" pyproject.toml
    sed -i "s/^description = .*/description = \"$ESCAPED_DESC\"/" pyproject.toml
    sed -i "s/^authors = .*/authors = [\"$ESCAPED_AUTHOR\"]/" pyproject.toml
fi

echo "   Project: $PROJECT_NAME"
echo "   Description: $DESCRIPTION"
echo "   Author: $AUTHOR"
echo ""

# Configure Poetry
echo "ðŸ“¦ Configuring Poetry..."
poetry config virtualenvs.in-project true

# Install dependencies
echo "ðŸ“¥ Installing dependencies from pyproject.toml..."
echo "   Core: fastapi, uvicorn, deepagents, openai"
echo "   DB: pymongo, certifi"
echo "   Config: pydantic, pydantic-settings, python-dotenv"
echo "   Dev: pytest, httpx, black, mypy, ruff, pre-commit"
poetry install

# Install pre-commit hooks
echo "ðŸª Installing pre-commit hooks..."
poetry run pre-commit install

# Create .env from example if it doesn't exist
if [ ! -f ".env" ]; then
    if [ -f "env.example" ]; then
        echo "ðŸ“ Creating .env file..."
        cp env.example .env
        echo ""
        echo "âš ï¸  Important: Edit .env and add your OPENAI_API_KEY"
    else
        echo "ðŸ“ Creating .env file..."
        cat > .env << EOF
# OpenAI API Key (required)
OPENAI_API_KEY=your_openai_api_key_here

# MongoDB Connection (optional)
MONGO_CONNECTION_STRING=mongodb://localhost:27017
EOF
    fi
else
    echo "âœ… .env file already exists"
fi

echo ""
echo "âœ… Setup complete!"
echo ""
echo "Next steps:"
echo "1. Edit .env and add your OPENAI_API_KEY"
echo "2. Customize src/agent/system_prompt.txt"
echo "3. Run: bin/run"
echo ""
echo "Pre-commit hooks installed. Your commits will be automatically checked for:"
echo "  - Code formatting (black)"
echo "  - Linting (ruff)"
echo "  - Type checking (mypy)"
echo "  - Common issues (trailing whitespace, secrets, etc.)"
echo ""
